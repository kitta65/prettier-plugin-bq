on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      # ----- rust -----
      - uses: actions/cache@v4
        with:
          key: ${{ hashFiles('./bq2cst/Cargo.lock') }}
          # https://doc.rust-lang.org/cargo/guide/cargo-home.html#caching-the-cargo-home-in-ci
          path: |
            ~/.cargo/bin
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/db
      - run: make build
        working-directory: ./bq2cst

      # ----- typescript -----
      # since packageManager is specified in package.json, any pnpm version is OK
      - run: mkdir -p bq2cst/{cjs,esm}
      - run: npm install -g pnpm
      - &setup-node
        uses: actions/setup-node@v5
        with:
          node-version: "20.x"
          registry-url: "https://registry.npmjs.org"
          cache: pnpm
      - run: pnpm install
      - run: pnpm --recursive run build

      # ----- upload -----
      # see https://github.com/actions/starter-workflows/blob/main/pages/static.yml
      # see https://docs.github.com/en/pages/getting-started-with-github-pages/using-custom-workflows-with-github-pages
      - uses: actions/configure-pages@v5
      - uses: actions/upload-pages-artifact@v4
        with:
          path: "./web/dist"
      - uses: actions/upload-artifact@v4
        with: &artifact-bq2cst-cjs
          name: bq2cst-cjs
          path: ./bq2cst/cjs
      - uses: actions/upload-artifact@v4
        with: &artifact-bq2cst-esm
          name: bq2cst-esm
          path: ./bq2cst/esm
      - uses: actions/upload-artifact@v4
        with: &artifact-prettier-plugin-bq
          name: prettier-plugin-bq
          path: ./prettier-plugin-bq/dist

      # ----- test -----
      - run: pnpm run test

  deploy-pkg:
    runs-on: ubuntu-latest
    if: ${{ github.ref_type == 'tag' }}
    needs: build
    steps:
      - uses: actions/checkout@v5
      # TODO: uncomment when ready to publish
      # #  always pass when ref_type == 'branch'
      # - uses: kitta65/tag-version-match@main
      #   with:
      #     file: ./prettier-plugin-bq/package.json
      #     query: .version
      #     pattern: '^([0-9]+\.[0-9]+\.[0-9]+)$'
      # - uses: kitta65/tag-version-match@main
      #   with:
      #     file: ./bq2cst/Cargo.toml
      #     query: .package.version
      #     pattern: '^([0-9]+\.[0-9]+\.[0-9]+)$'
      - run: npm install -g pnpm
      - *setup-node
      - uses: actions/download-artifact@v5
        with: *artifact-bq2cst-cjs
      - uses: actions/download-artifact@v5
        with: *artifact-bq2cst-esm
      - uses: actions/download-artifact@v5
        with: *artifact-prettier-plugin-bq
      # needed to resolve workspace protocol of dependency "bq2cst"
      - run: pnpm install
      - run: pnpm run release
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  deploy-page:
    runs-on: ubuntu-latest
    if: ${{ github.ref_type == 'tag' }}
    permissions:
      pages: write
      id-token: write
    needs: build
    steps:
      - id: deployment
        if: ${{ github.ref_type == 'tag' }}
        uses: actions/deploy-pages@v4
